<!doctype html>
<html>
  <head>
    <script src="/simpl.js"></script>
    <title>simpl chat</title>
  </head>
<body>

<input id="input" type="text" value="" autocomplete="off">

<pre id="messages"></pre>

<script>
var getId = document.getElementById.bind(document)

window.client = null

var input = getId('input')
input.focus()

function keyupListener (e) {
  if (e.keyCode === 13) {
    append('<you> ' + input.value)
    client.send(input.value)
    input.value = ''
  }
}

var messages = getId('messages')

function append (text) {
  messages.appendChild(
    document.createTextNode(
      '['
    + new Date()
      .toTimeString()
      .split(':')
      .slice(0, 2)
      .join(':')
    + '] ' + text + '\n'
    )
  )
}

;(function connect () {
  client = simpl()

  client.once('error', function (err) {
    client.destroy()
    input.removeEventListener('keyup', keyupListener)
    console.error(err)
    setTimeout(function () {
      console.log('retrying connection')
      connect()
    }, 500)
  })

  client.once('ready', function () {
    input.addEventListener('keyup', keyupListener)
  })

  client.on('message', function (message) {
    append(message)
  })
}())
</script>

</body>
</html>